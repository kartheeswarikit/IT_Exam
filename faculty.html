<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Faculty Dashboard - Exam Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

/* === CSS Variables === */
:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --primary-light: #818cf8;
  --secondary: #8b5cf6;
  --accent: #ec4899;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #06b6d4;
  
  --bg-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --bg-card: #ffffff;
  --bg-hover: #f8fafc;
  --bg-light: #f1f5f9;
  
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-light: #94a3b8;
  
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  
  --radius-sm: 8px;
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 24px;
}

/* === Global Reset === */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-main);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.6;
}

/* === Header === */
header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 24px 32px;
  box-shadow: var(--shadow-lg);
  position: sticky;
  top: 0;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.header-container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.header-left h1 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 4px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#welcome {
  font-size: 14px;
  opacity: 0.95;
  font-weight: 500;
}

.logout-btn {
  background: rgba(255,255,255,0.2);
  color: white;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: var(--radius);
  padding: 12px 24px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 8px;
}

.logout-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* === Main Container === */
.main-container {
  max-width: 1400px;
  margin: 32px auto;
  padding: 0 24px;
}

/* === Card Styles === */
.card {
  background: var(--bg-card);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  margin-bottom: 24px;
  padding: 32px;
  animation: slideUp 0.5s ease;
  border: 1px solid var(--border-light);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: var(--shadow-xl);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border-light);
}

.card-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.card-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: var(--shadow);
}

/* === Quick Actions === */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.action-card {
  background: linear-gradient(135deg, var(--primary-light), var(--secondary));
  color: white;
  padding: 24px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  text-align: center;
}

.action-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.action-card-icon {
  font-size: 32px;
  margin-bottom: 12px;
}

.action-card-title {
  font-size: 14px;
  font-weight: 600;
  opacity: 0.95;
}

/* === Form Controls === */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
}

.form-control {
  flex: 1;
  min-width: 200px;
}

input[type="file"],
input[type="date"],
select,
.input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.3s ease;
  background: var(--bg-card);
}

input[type="file"]:hover,
input[type="date"]:hover,
select:hover,
.input:hover {
  border-color: var(--primary-light);
}

input[type="file"]:focus,
input[type="date"]:focus,
select:focus,
.input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* === Buttons === */
.btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: var(--shadow);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn:active {
  transform: translateY(0);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #059669);
}

.btn-warning {
  background: linear-gradient(135deg, var(--warning), #d97706);
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #dc2626);
}

.btn-info {
  background: linear-gradient(135deg, var(--info), #0891b2);
}

.btn-secondary {
  background: linear-gradient(135deg, #64748b, #475569);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* === Status Messages === */
.status-message {
  padding: 12px 16px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  margin-top: 12px;
  animation: slideDown 0.3s ease;
}

.status-success {
  background: #d1fae5;
  color: #065f46;
  border-left: 4px solid var(--success);
}

.status-error {
  background: #fee2e2;
  color: #991b1b;
  border-left: 4px solid var(--danger);
}

.status-info {
  background: #dbeafe;
  color: #1e40af;
  border-left: 4px solid var(--info);
}

/* === Divider === */
hr {
  border: none;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
  margin: 32px 0;
}

/* === Table Container === */
.table-container {
  width: 100%;
  overflow-x: auto;
  margin-top: 24px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}

/* === Modern Table === */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 800px;
}

thead {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
}

th {
  padding: 16px 12px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: sticky;
  top: 0;
  z-index: 10;
  border: none;
}

th:first-child {
  border-top-left-radius: var(--radius-lg);
}

th:last-child {
  border-top-right-radius: var(--radius-lg);
}

tbody tr {
  background: white;
  transition: all 0.2s ease;
}

tbody tr:nth-child(even) {
  background: var(--bg-light);
}

tbody tr:hover {
  background: #e0e7ff;
  transform: scale(1.01);
  box-shadow: var(--shadow);
}

td {
  padding: 14px 12px;
  border-bottom: 1px solid var(--border-light);
  font-size: 14px;
  color: var(--text-primary);
}

td input[type="text"] {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
}

/* === Stats Grid === */
.stats-container {
  background: linear-gradient(135deg, #f0f9ff, #e0e7ff);
  padding: 24px;
  border-radius: var(--radius-lg);
  margin: 24px 0;
  box-shadow: var(--shadow);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: var(--radius);
  text-align: center;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
  border: 2px solid var(--border-light);
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary);
}

.stat-value {
  font-size: 32px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 4px;
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* === Year Cards Grid === */
#yearCardArea {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

.year-card {
  background: linear-gradient(135deg, #fefefe, #f8fafc);
  border: 2px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.year-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.year-card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary);
}

.year-card h4 {
  color: var(--primary);
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
}

.year-card p {
  margin: 8px 0;
  font-size: 14px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
}

.year-card p b {
  color: var(--text-primary);
}

.year-card .attendance-badge {
  display: inline-block;
  padding: 6px 12px;
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
  border-radius: 20px;
  font-weight: 700;
  font-size: 14px;
  margin-top: 8px;
}

/* === Progress Bar === */
.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border-light);
  border-radius: 4px;
  overflow: hidden;
  margin: 12px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  transition: width 0.5s ease;
  border-radius: 4px;
}

/* === Badge === */
.badge {
  display: inline-flex;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-success {
  background: #d1fae5;
  color: #065f46;
}

.badge-danger {
  background: #fee2e2;
  color: #991b1b;
}

.badge-warning {
  background: #fef3c7;
  color: #92400e;
}

.badge-info {
  background: #dbeafe;
  color: #1e40af;
}

/* === Empty State === */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state-text {
  font-size: 16px;
  color: var(--text-secondary);
}

/* === Loading Spinner === */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* === Animations === */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* === Responsive Design === */
@media (max-width: 768px) {
  .header-container {
    flex-direction: column;
    text-align: center;
  }

  .header-left h1 {
    font-size: 1.5rem;
  }

  .main-container {
    padding: 0 16px;
    margin: 16px auto;
  }

  .card {
    padding: 20px;
  }

  .form-row {
    flex-direction: column;
  }

  .form-control {
    min-width: 100%;
  }

  .quick-actions {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  #yearCardArea {
    grid-template-columns: 1fr;
  }

  table {
    font-size: 12px;
  }

  th, td {
    padding: 10px 8px;
  }

  .btn {
    width: 100%;
    justify-content: center;
  }
}

/* === Print Styles === */
@media print {
  body {
    background: white;
  }

  .header, .logout-btn, .btn, .quick-actions {
    display: none;
  }

  .card {
    box-shadow: none;
    page-break-inside: avoid;
  }

  table {
    page-break-inside: auto;
  }

  tr {
    page-break-inside: avoid;
  }
}

/* === Tooltip === */
[data-tooltip] {
  position: relative;
  cursor: help;
}

[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 12px;
  background: var(--text-primary);
  color: white;
  border-radius: var(--radius-sm);
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  margin-bottom: 8px;
}

[data-tooltip]:hover::after {
  opacity: 1;
}

/* === Utility Classes === */
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-muted { color: var(--text-secondary); }
.text-small { font-size: 13px; }
.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 24px; }
.mt-0 { margin-top: 0; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }

</style>
</head>

<body onload="initFaculty()">

  <header>
    <div class="header-container">
      <div class="header-left">
        <h1>‚ú® Faculty Dashboard</h1>
        <div id="welcome"></div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <span>üö™</span>
        <span>Logout</span>
      </button>
    </div>
  </header>

  <div class="main-container">

    <!-- Quick Actions -->
    <div class="quick-actions">
      <div class="action-card" onclick="window.open('Seating.html', '_blank')">
        <div class="action-card-icon">ü™ë</div>
        <div class="action-card-title">Seating Arrangement</div>
      </div>
      <div class="action-card" onclick="downloadExcelTemplate()">
        <div class="action-card-icon">üìÑ</div>
        <div class="action-card-title">Download Template</div>
      </div>
      <div class="action-card" onclick="document.getElementById('excelFile').click()">
        <div class="action-card-icon">üì§</div>
        <div class="action-card-title">Upload Excel</div>
      </div>
      <div class="action-card" onclick="document.getElementById('dateFilter').focus()">
        <div class="action-card-icon">üìä</div>
        <div class="action-card-title">View Reports</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üì§</div>
        <h2>Upload Seating Data</h2>
      </div>
      
      <div class="form-row">
        <div class="form-control">
          <label class="form-label">Select Excel File</label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />
        </div>
        <button class="btn btn-success" id="btnUpload" onclick="uploadExcel()">
          <span>‚è´</span>
          <span>Upload & Save</span>
        </button>
      </div>
      <div id="uploadMsg"></div>
    </div>

    <!-- Download Hall Plan -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üìã</div>
        <h2>Download Hall Plan</h2>
      </div>
      
      <div class="form-row">
        <div class="form-control">
          <label class="form-label">Select Date</label>
          <input type="date" id="planDate" class="input" />
        </div>

        <div class="form-control">
          <label class="form-label">Select Batch</label>
          <select id="planBatch" class="input">
            <option value="">-- Select --</option>
            <option value="FN">FN</option>
            <option value="AN">AN</option>
          </select>
        </div>

        <div class="form-control">
          <label class="form-label">Select Exam</label>
          <select id="internalExam" class="input">
            <option value="I">Internal Exam I</option>
            <option value="II">Internal Exam II</option>
          </select>
        </div>
      </div>

      <div class="form-row mt-2">
        <button class="btn btn-info" onclick="downloadHallPlan()">
          <span>‚è¨</span>
          <span>Download Hall Plan PDF</span>
        </button>
        <button class="btn btn-secondary" onclick="generateHallPlanSchedule()">
          <span>üìÖ</span>
          <span>Download Schedule PDF</span>
        </button>
      </div>
    </div>

    <hr>

    <!-- Absentees & Summary -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üìä</div>
        <h2>Absentees & Attendance Summary</h2>
      </div>

      <div class="form-row">
        <div class="form-control">
          <label class="form-label">Date</label>
          <input type="date" id="dateFilter" class="input" />
        </div>

        <div class="form-control">
          <label class="form-label">Batch</label>
          <select id="batchSelect" class="input">
            <option value="FN">FN</option>
            <option value="AN">AN</option>
          </select>
        </div>

        <div class="form-control">
          <label class="form-label">Department</label>
          <select id="deptSelect" class="input"></select>
        </div>

        <button class="btn" onclick="loadAbsentees()">
          <span>üîç</span>
          <span>Load Data</span>
        </button>
      </div>

      <!-- Statistics -->
      <div id="deptStats" class="stats-container" style="display:none;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Students</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPresent" style="color: var(--success);">0</div>
            <div class="stat-label">Present</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAbsent" style="color: var(--danger);">0</div>
            <div class="stat-label">Absent</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statOD" style="color: var(--warning);">0</div>
            <div class="stat-label">On Duty</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPercent" style="color: var(--primary);">0%</div>
            <div class="stat-label">Attendance</div>
          </div>
        </div>
      </div>

      <!-- Absentees Table -->
      <div id="absenteesArea" class="table-container"></div>

      <!-- Download Button -->
      <div class="form-row mt-3">
        <button class="btn btn-success" onclick="downloadAbsenteesCSV()">
          <span>‚è¨</span>
          <span>Download Absentees CSV</span>
        </button>
      </div>

      <hr>

      <!-- Year Summary -->
      <div class="card-header mt-3">
        <div class="card-icon">üìà</div>
        <h2>Year & Section Summary</h2>
      </div>

      <!-- Year Cards Grid -->
      <div id="yearCardArea"></div>

      <!-- Year Summary Table -->
      <div id="yearSummaryArea" class="table-container"></div>

      <button class="btn btn-success mt-2" id="downloadYearSummary" style="display:none;">
        <span>üì•</span>
        <span>Download Excel Summary</span>
      </button>
    </div>

  </div>

<script>
let user = null;
let absentees = [];
let currentTotals = null;
let currentYearSummary = null;

function initFaculty(){
  user = requireRole('Faculty');
  if(!user) return;
  document.getElementById('welcome').innerText = `Signed in as: ${user.name} ‚Äî Dept: ${user.department || 'All'}`;
  populateDepartments();
}

async function populateDepartments(){
  const sel = document.getElementById('deptSelect');
  sel.innerHTML = '';
  if(user.department){
    const op = document.createElement('option');
    op.value = user.department;
    op.textContent = user.department;
    sel.appendChild(op);
    sel.disabled = true;
  }
}

function downloadExcelTemplate(){
  const headers = ["Date","Department","Batch","Hall No","Student Roll No","Name","Seating No","Subject Code","Subject","Year","Section"];
  const wb = XLSX.utils.book_new();
  const ws_data = [headers];
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  ws['!cols'] = [
    {wch:12},{wch:15},{wch:10},{wch:18},{wch:20},{wch:12},{wch:15},{wch:20},{wch:8},{wch:8},{wch:10},{wch:20}
  ];

  XLSX.utils.book_append_sheet(wb, ws, "SeatingTemplate");
  XLSX.writeFile(wb, "Faculty_Seating_Template.xlsx");
}

async function uploadExcel(){
  const f = document.getElementById('excelFile').files[0];
  const msgEl = document.getElementById('uploadMsg');
  msgEl.innerHTML = '';
  
  if(!f){
    msgEl.innerHTML = '<div class="status-message status-error">Please choose a file</div>';
    return;
  }
  
  document.getElementById('btnUpload').disabled = true;
  msgEl.innerHTML = '<div class="status-message status-info">Parsing file... <span class="loading"></span></div>';
  
  try {
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data,{type:'array'});
    const sname = wb.SheetNames[0];
    const sheet = wb.Sheets[sname];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
    
    if(!rows.length){
      msgEl.innerHTML = '<div class="status-message status-error">No rows found in file</div>';
      document.getElementById('btnUpload').disabled=false;
      return;
    }
    
    const normalized = rows.map(r=>({
      Date: r['Date'] || r['date'] || r['DATE'] || '',
      Department: r['Department'] || r['department'] || '',
      "Batch": r['Batch'] || '',
      "Hall No": r['Hall No'] || r['Hall'] || r['HallNo'] || '',
      "Student Roll No": r['Student Roll No'] || r['Roll No'] || r['RollNo'] || '',
      "Name": r['Name'] || r['name'] || '',
      "Seating No": r['Seating No'] || r['Seat No'] || r['SeatNo'] || '',
      "Subject Code": r['Subject Code'] || r['SubjectCode'] || '',
      Subject: r['Subject'] || r['Subject Name'] || '',
      "Year": r['Year'] || '',
      "Section": r['Section'] || ''
    }));
    
    const res = await apiFetch({ action:'uploadSeating', rows: normalized });
    
    if(res.success){
      msgEl.innerHTML = '<div class="status-message status-success">‚úÖ Upload successful!</div>';
    } else {
      msgEl.innerHTML = `<div class="status-message status-error">‚ùå Upload failed: ${res.message||JSON.stringify(res)}</div>`;
    }
  } catch(err){
    console.error(err);
    msgEl.innerHTML = `<div class="status-message status-error">‚ùå Error: ${err.message}</div>`;
  } finally{
    document.getElementById('btnUpload').disabled=false;
  }
}

async function loadAbsentees(){
  const dept = document.getElementById('deptSelect').value || user.department;
  const date = document.getElementById('dateFilter').value || '';
  const batch = document.getElementById('batchSelect').value || '';
  
  document.getElementById('absenteesArea').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><div class="empty-state-text">Loading data...</div></div>';
  
  const res = await apiFetch({ action:'getAbsentees', department: dept, date, batch });

  if(!res.success){
    document.getElementById('absenteesArea').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">Error: ${res.message||'Unknown error'}</div></div>`;
    return;
  }
  
  absentees = res.absentees || [];
  currentTotals = res.totals || null;
  currentYearSummary = res.yearSummary || null;
  
  renderAbsentees();
  renderTotals();
  renderYearSummary();
  renderYearCards();
}

function renderAbsentees(){
  const area = document.getElementById('absenteesArea');
  const filtered = (absentees || []).filter(r => {
    const s = (r.Status || "").toString().trim().toUpperCase();
    return s === "ABSENT" || s === "OD";
  });

  if(!filtered.length){
    area.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div class="empty-state-text">No absentees or OD entries found</div></div>';
    return;
  }
  
  let html = '<table><thead><tr><th>Date</th><th>Hall</th><th>Seat</th><th>Roll No</th><th>Name</th><th>Year</th><th>Section</th><th>Status</th><th>Reason</th><th>Action</th></tr></thead><tbody>';
  
  filtered.forEach((r, idx)=>{
    const reason = r.Reason||'';
    const statusBadge = r.Status === 'ABSENT' ? 'badge-danger' : 'badge-warning';
    html += `<tr data-idx="${idx}">
      <td>${escapeHtml(r.Date||'')}</td>
      <td>${escapeHtml(r.HallNo||'')}</td>
      <td>${escapeHtml(r.SeatNo||'')}</td>
      <td><strong>${escapeHtml(r.RollNo||'')}</strong></td>
      <td>${escapeHtml(r.Name||'')}</td>
      <td>${escapeHtml(r.Year||'')}</td>
      <td>${escapeHtml(r.Section||'')}</td>
      <td><span class="badge ${statusBadge}">${escapeHtml(r.Status||'')}</span></td>
      <td><input type="text" id="reason_${idx}" value="${escapeHtml(reason)}"></td>
      <td><button class="btn btn-success btn-sm" onclick="saveReason(${idx})">Save</button></td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  area.innerHTML = html;
}

function renderTotals(){
  const container = document.getElementById('deptStats');
  
  if(!currentTotals){
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  document.getElementById('statTotal').textContent = currentTotals.total || 0;
  document.getElementById('statPresent').textContent = currentTotals.present || 0;
  document.getElementById('statAbsent').textContent = currentTotals.absent || 0;
  document.getElementById('statOD').textContent = currentTotals.od || 0;
  document.getElementById('statPercent').textContent = (currentTotals.attendancePercent || 0) + '%';
}

function renderYearSummary(){
  const area = document.getElementById('yearSummaryArea');
  const btn = document.getElementById('downloadYearSummary');
  
  if(!currentYearSummary){
    area.innerHTML = '';
    btn.style.display = 'none';
    return;
  }
  
  btn.style.display = 'block';
  
  let html = '<table><thead><tr><th>Year</th><th>Section</th><th>Total</th><th>Present</th><th>Absent</th><th>OD</th><th>Attendance %</th></tr></thead><tbody>';
  
  for(const yr of Object.keys(currentYearSummary).sort()){
    const y = currentYearSummary[yr];
    for(const sec of Object.keys(y.sections).sort()){
      const s = y.sections[sec];
      const pct = s.total===0?0:Math.round((s.present / s.total)*10000)/100;
      html += `<tr>
        <td><strong>${escapeHtml(yr)}</strong></td>
        <td>${escapeHtml(sec)}</td>
        <td>${s.total}</td>
        <td style="color:var(--success);font-weight:600;">${s.present}</td>
        <td style="color:var(--danger);font-weight:600;">${s.absent}</td>
        <td style="color:var(--warning);font-weight:600;">${s.od}</td>
        <td><span class="badge badge-info">${pct}%</span></td>
      </tr>`;
    }
  }
  
  html += '</tbody></table>';
  area.innerHTML = html;
}

function renderYearCards(){
  const area = document.getElementById('yearCardArea');
  
  if(!currentYearSummary){
    area.innerHTML = '';
    return;
  }

  let html = '';
  for(const yr of Object.keys(currentYearSummary).sort()){
    const y = currentYearSummary[yr];
    for(const sec of Object.keys(y.sections).sort()){
      const s = y.sections[sec];
      const pct = s.total===0?0:Math.round((s.present / s.total)*10000)/100;
      
      html += `<div class="year-card" onclick="viewSection('${yr}','${sec}')">
        <h4>Year ${escapeHtml(yr)} - Section ${escapeHtml(sec)}</h4>
        <p><span>Total:</span> <b>${s.total}</b></p>
        <p><span>Present:</span> <b style="color:var(--success);">${s.present}</b></p>
        <p><span>Absent:</span> <b style="color:var(--danger);">${s.absent}</b></p>
        <p><span>On Duty:</span> <b style="color:var(--warning);">${s.od}</b></p>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${pct}%"></div>
        </div>
        <span class="attendance-badge">${pct}% Attendance</span>
      </div>`;
    }
  }
  
  area.innerHTML = html;
}

function viewSection(year, section){
  const rows = absentees.filter(r=>r.Year==year && r.Section==section);
  if(rows.length){
    renderAbsenteesTable(rows);
  }
}

function renderAbsenteesTable(rows){
  const area = document.getElementById('absenteesArea');
  
  if(!rows.length){
    area.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">No data for this section</div></div>';
    return;
  }
  
  let html = '<table><thead><tr><th>Date</th><th>Hall</th><th>Seat</th><th>Roll No</th><th>Name</th><th>Year</th><th>Section</th><th>Status</th><th>Reason</th><th>Action</th></tr></thead><tbody>';
  
  rows.forEach((r, idx)=>{
    const reason = r.Reason||'';
    const statusBadge = r.Status === 'ABSENT' ? 'badge-danger' : 'badge-warning';
    html += `<tr data-idx="${idx}">
      <td>${escapeHtml(r.Date||'')}</td>
      <td>${escapeHtml(r.HallNo||'')}</td>
      <td>${escapeHtml(r.SeatNo||'')}</td>
      <td><strong>${escapeHtml(r.RollNo||'')}</strong></td>
      <td>${escapeHtml(r.Name||'')}</td>
      <td>${escapeHtml(r.Year||'')}</td>
      <td>${escapeHtml(r.Section||'')}</td>
      <td><span class="badge ${statusBadge}">${escapeHtml(r.Status||'')}</span></td>
      <td><input type="text" id="reason_${idx}" value="${escapeHtml(reason)}"></td>
      <td><button class="btn btn-success btn-sm" onclick="saveReason(${idx})">Save</button></td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  area.innerHTML = html;
}

async function saveReason(idx) {
  const r = absentees[idx];
  if (!r) return alert("Invalid record");

  const lockRes = await apiFetch({ action: "getLockStatus", date: r.Date });
  if (lockRes.lock === "Locked") {
    alert(`Editing disabled ‚Äî ${r.Date} is locked by CoE.`);
    document.querySelectorAll("button.btn").forEach(b => {
      if (b.textContent.includes("Save")) b.disabled = true;
    });
    document.querySelectorAll("input[id^='reason_']").forEach(i => (i.disabled = true));
    return;
  }

  const reason = document.getElementById("reason_" + idx).value;
  const res = await apiFetch({
    action: "saveReason",
    rollNo: r.RollNo,
    reason,
    date: r.Date,
    role: user.role
  });

  if (res.success) {
    alert("‚úÖ Saved successfully");
    absentees[idx].Reason = reason;
  } else {
    alert("‚ùå Save failed: " + (res.message || ""));
  }
}

function escapeHtml(s){
  if(!s && s!==0) return '';
  return String(s).replace(/[&<>"'`]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m]);
}

function downloadAbsenteesCSV(){
  if(!absentees.length){
    alert('No data to download');
    return;
  }

  const batch = document.getElementById('batchSelect').value || '';
  const hdr = ["Date","Batch","Department","HallNo","SeatNo","RollNo","Name","Year","Section","Status","Reason"];
  const rows = absentees.map(r => [
    r.Date, batch, r.Department, r.HallNo, r.SeatNo, r.RollNo, r.Name || "", r.Year || "", r.Section || "", r.Status, r.Reason || ""
  ]);

  const csv = [hdr.join(","), ...rows.map(r=>r.map(s=>`"${String(s).replace(/"/g,'""')}"`).join(","))].join("\n");
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`absentees_${batch}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('downloadYearSummary').addEventListener('click', () => {
  if(!currentYearSummary){
    alert("No data to export");
    return;
  }

  const ws_data = [["Year","Section","Total","Present","Absent","OD","Attendance %"]];
  
  for(const yr of Object.keys(currentYearSummary).sort()){
    const y = currentYearSummary[yr];
    for(const sec of Object.keys(y.sections).sort()){
      const s = y.sections[sec];
      const pct = s.total===0?0:Math.round((s.present / s.total)*10000)/100;
      ws_data.push([yr, sec, s.total, s.present, s.absent, s.od, pct]);
    }
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Year Summary");
  XLSX.writeFile(wb, `YearSummary_${new Date().toISOString().split('T')[0]}.xlsx`);
});

function logout() {
  localStorage.removeItem("user");
  location.href = "index.html";
}

async function downloadHallPlan() {
  const selectedDate = document.getElementById("planDate").value;
  const selectedBatch = document.getElementById("planBatch").value;
  const selectedExam = document.getElementById("internalExam").value;

  if (!selectedDate || !selectedBatch || !selectedExam) {
    alert("Please select Date, Batch, and Internal Exam");
    return;
  }

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.department) {
    alert("Department information missing. Please login again.");
    return;
  }

  try {
    const res = await apiFetch({
      action: "getStudentSeatingData",
      date: selectedDate,
      batch: selectedBatch,
      department: user.department
    });

    let data = Array.isArray(res) ? res : res.success ? res.data : res.result;
    if (!data || data.length === 0) {
      alert("No seating data found for your department on this date and batch.");
      return;
    }

    await generatePDF(data, selectedExam, user.department);
  } catch (err) {
    console.error("downloadHallPlan error:", err);
    alert("Error fetching hall plan: " + (err.message || err));
  }
}

async function generatePDF(data, examType, department) {
  if (!Array.isArray(data) || data.length === 0) {
    alert("No data to generate PDF.");
    return;
  }

  const departmentMap = {
    "CSE": "COMPUTER SCIENCE AND ENGINEERING",
    "ECE": "ELECTRONICS AND COMMUNICATION ENGINEERING",
    "ME": "MECHANICAL ENGINEERING",
    "CE": "CIVIL ENGINEERING",
    "ADS": "ARTIFICIAL INTELLIGENCE AND DATA SCIENCE"
  };

  const departmentFullName =
  department && departmentMap[department]
    ? departmentMap[department]
    : (department ? department.toUpperCase() : "UNKNOWN DEPARTMENT");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "pt", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const logoUrl = "logo.jpeg";

  const getField = (obj, names) => {
    for (const n of names) if (obj[n] !== undefined && obj[n] !== null) return obj[n];
    return "";
  };

  const firstSample = data[0] || {};
  const rawDateForFile = getField(firstSample, ["Date", "date"]) || "unknown";
  const dateObjForFile = new Date(rawDateForFile);
  const dateForName = `${dateObjForFile.getDate().toString().padStart(2,'0')}_${(dateObjForFile.getMonth()+1).toString().padStart(2,'0')}_${dateObjForFile.getFullYear()}`;
  const batchTextForName = getField(firstSample, ["Batch", "batch"]) || "Batch";

  const halls = [...new Set(data.map(row => getField(row, ["Hall No", "HallNo"])))].filter(Boolean);

  let imgData = null;
  try {
    const resp = await fetch(logoUrl);
    if (resp.ok) {
      const blob = await resp.blob();
      const bitmap = await createImageBitmap(blob);
      const canvas = document.createElement("canvas");
      canvas.width = bitmap.width;
      canvas.height = bitmap.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(bitmap, 0, 0);
      imgData = canvas.toDataURL("image/jpeg");
    }
  } catch(e) { console.warn("Logo load failed:", e); }

  for (let i = 0; i < halls.length; i++) {
    const hall = halls[i];
    const students = data.filter(r => getField(r, ["Hall No", "HallNo"]) == hall);

    if (i > 0) doc.addPage();

    let y = 20;
    if (imgData) {
      const logoWidth = 250;
      const logoHeight = 50;
      doc.addImage(imgData, "JPEG", (pageWidth - logoWidth)/2, y, logoWidth, logoHeight);
      y += logoHeight + 30;
    }

    doc.setFont("times", "bold");
    doc.setFontSize(16);
    const centerText = (txt, yPos) => doc.text(txt, pageWidth/2, yPos, { align: "center" });
    doc.setFontSize(12);
    centerText("Office of the Controller of Examinations", y); y += 18;
    centerText("ODD Semester of 2025 ‚Äì 2026", y); y += 18;
    centerText("HALL WISE SEATING ARRANGEMENT", y); y += 18;
    centerText(`DEPARTMENT OF ${departmentFullName}`, y); y += 18;
    centerText(`INTERNAL EXAMINATION ‚Äì ${examType}`, y); y += 25;

    const sample = students[0] || data[0];
    const rawDate = getField(sample, ["Date", "date"]);
    const dateObj = new Date(rawDate);
    const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getFullYear()}`;
    const batchText = getField(sample, ["Batch", "batch"]);

    doc.setFont("times", "normal");
    doc.setFontSize(12);
    doc.text(`Date: ${dateStr}`, 50, y);
    doc.text(`Session: ${batchText}`, pageWidth/2, y, { align: "center" });
    doc.text(`Hall: ${hall}`, pageWidth - 50, y, { align: "right" });
    y += 15;

    const seatSeries = {};
    students.forEach(s => {
      const seatNo = getField(s, ["Seating No", "SeatNo", "Seat No"]);
      if (!seatNo) return;
      const series = seatNo.match(/^[A-Z]+/i)?.[0] || "?";
      if (!seatSeries[series]) seatSeries[series] = [];
      const seatNum = parseInt(seatNo.match(/\d+/)?.[0] || "0");
      seatSeries[series].push({
        seatNo,
        roll: getField(s, ["Student Roll No", "RollNo", "Roll No"]),
        seatNum,
        year: getField(s, ["Year", "year"]),
        section: getField(s, ["Section", "section"]),
        department: getField(s, ["Department", "Dept", "department"]),
        subject: getField(s, ["Subject Code", "SubjectCode", "Subject"])
      });
    });

    Object.keys(seatSeries).forEach(series => {
      seatSeries[series].sort((a, b) => a.seatNum - b.seatNum);
    });

    const maxRows = Math.max(...Object.values(seatSeries).map(arr => arr.length));
    const tableHeader = Object.keys(seatSeries).sort();
    const tableHeaderRow = [];
    for (let _ of tableHeader) tableHeaderRow.push("Seat No", "Roll No");

    const tableBody = [];
    for (let r = 0; r < maxRows; r++) {
      const row = [];
      for (const s of tableHeader) {
        const seat = seatSeries[s][r];
        row.push(seat ? seat.seatNo : "", seat ? seat.roll : "");
      }
      tableBody.push(row);
    }

    const maxSubRows = Math.max(
      ...Object.values(seatSeries).map(group => {
        const map = {};
        group.forEach(s => {
          const key = `${s.year || ""} ${s.section || ""}`.trim();
          map[key] = (map[key] || 0) + 1;
        });
        return Object.keys(map).length;
      })
    );

    for (let subRow = 0; subRow < maxSubRows; subRow++) {
      const row = [];
      for (const s of tableHeader) {
        const group = seatSeries[s];
        if (group && group.length > 0) {
          const map = {};
          group.forEach(st => {
            const key = `${st.year || ""} ${st.department || ""} ${st.section || ""}`.trim();
            map[key] = (map[key] || 0) + 1;
          });
          const entries = Object.entries(map);
          if (entries[subRow]) {
            const [yrsec, cnt] = entries[subRow];
            row.push(yrsec, cnt.toString());
          } else {
            row.push("", "");
          }
        } else {
          row.push("", "");
        }
      }
      tableBody.push(row);
    }

    const grandRow = new Array(tableHeader.length * 2).fill("");
    const lastSeatIndex = tableHeader.length * 2 - 2;
    grandRow[lastSeatIndex] = "Total";
    grandRow[lastSeatIndex + 1] = students.length.toString();
    tableBody.push(grandRow);

    doc.autoTable({
      head: [tableHeaderRow],
      body: tableBody,
      startY: y,
      theme: "grid",
      headStyles: { fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.5, fontStyle: "bold" },
      styles: {
        font: "times",
        fontSize: 10,
        textColor: 0,
        halign: "center",
        valign: "middle",
        lineColor: 0,
        lineWidth: 0.5,
        fontStyle: "normal"
      },
      didParseCell: function (data) {
        if (data.cell.raw && (data.cell.raw.match(/^[0-9]{2}[A-Z]+[0-9]+$/i) || data.cell.raw === "Total" || data.cell.raw === students.length.toString())) {
          data.cell.styles.fontStyle = "bold";
        }
      },
      tableWidth: "auto",
      margin: { left: 40, right: 40 }
    });

    const subjectCounts = {};
    students.forEach(s => {
      const subj = getField(s, ["Subject Code", "SubjectCode", "Subject"]);
      if (subj) subjectCounts[subj] = (subjectCounts[subj] || 0) + 1;
    });

    let subjY = doc.lastAutoTable.finalY + 25;
    doc.setFont("times", "bold");
    doc.setFontSize(12);
    doc.text("Subject-wise Count:", 60, subjY);
    subjY += 25;

    doc.setFont("times", "normal");
    Object.entries(subjectCounts).forEach(([subj, count]) => {
      doc.text(`${subj} - ${count}`, 80, subjY);
      subjY += 14;
    });

    doc.setFontSize(13);
    doc.text("Department Exam Cell In-charge", 90, pageHeight - 40);
    doc.text("HoD", pageWidth - 130, pageHeight - 40, { align: "right" });
  }

  doc.save(`HallPlan_${dateForName}_${batchTextForName}_Exam${examType}.pdf`);
}

async function generateHallPlanSchedule() {
  const selectedDate = document.getElementById("planDate").value;
  const selectedBatch = document.getElementById("planBatch").value;
  const selectedExam = document.getElementById("internalExam").value;

  if (!selectedDate || !selectedBatch || !selectedExam) {
    alert("Please select Date, Batch, and Internal Exam");
    return;
  }

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.department) {
    alert("Department information missing. Please login again.");
    return;
  }

  try {
    const res = await apiFetch({
      action: "getStudentSeatingData",
      date: selectedDate,
      batch: selectedBatch,
      department: user.department
    });

    const data = Array.isArray(res) ? res : res.success ? res.data : res.result;
    if (!data || data.length === 0) {
      alert("No data to generate hall plan schedule.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("portrait", "pt", "a4");
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const logoUrl = "logo.jpeg";

    const departmentFullName = {
      "CSE": "COMPUTER SCIENCE AND ENGINEERING",
      "ECE": "ELECTRONICS AND COMMUNICATION ENGINEERING",
      "ME": "MECHANICAL ENGINEERING",
      "CE": "CIVIL ENGINEERING",
      "ADS": "ARTIFICIAL INTELLIGENCE AND DATA SCIENCE"
    }[user.department] || user.department;

    let imgData = null;
    try {
      const resp = await fetch(logoUrl);
      if (resp.ok) {
        const blob = await resp.blob();
        const bitmap = await createImageBitmap(blob);
        const canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bitmap, 0, 0);
        imgData = canvas.toDataURL("image/jpeg");
      }
    } catch(e) { console.warn("Logo load failed:", e); }

    const groupedByHall = {};
    data.forEach(row => {
      const hall = row["Hall No"] || row["HallNo"];
      if (!groupedByHall[hall]) groupedByHall[hall] = [];
      groupedByHall[hall].push(row);
    });

    let y = 230;
    function addHeader() {
      let yHeader = 20;
      if (imgData) {
        const logoWidth = 250;
        const logoHeight = 50;
        doc.addImage(imgData, "JPEG", (pageWidth - logoWidth)/2, yHeader, logoWidth, logoHeight);
        yHeader += logoHeight + 30;
      }

      doc.setFont("times", "bold");
      doc.setFontSize(14);
      doc.text("Office of the Controller of Examinations", pageWidth / 2, 90, { align: "center" });
      doc.text("ODD Semester of 2025 ‚Äì 2026", pageWidth / 2, 110, { align: "center" });
      doc.text("Hall Plan Schedule", pageWidth / 2, 130, { align: "center" });

      doc.setFont("times", "normal");
      doc.setFontSize(12);
      doc.text(`DEPARTMENT OF ${departmentFullName}`, pageWidth / 2, 150, { align: "center" });
      doc.text(`INTERNAL EXAMINATION - ${selectedExam}`, pageWidth / 2, 170, { align: "center" });

      doc.setFontSize(12);
      doc.text(`Date: ${selectedDate}`, 70, 190);
      doc.text(`Session: ${selectedBatch}`, pageWidth - 70, 190, { align: "right" });

      const tableLeft = 50;
      const tableRight = pageWidth - 50;
      const headerHeight = 25;

      doc.setLineWidth(0.5);
      doc.rect(tableLeft, 200, tableRight - tableLeft, headerHeight);
      const colX = [110, 200, 350, 500];
      colX.forEach(x => doc.line(x, 200, x, 225));

      const headers = ["Hall No", "Course Code", "Year & Section", "Roll Number", "Total"];
      const centers = [80, 155, 275, 425, 525];

      doc.setFont("times", "bold");
      doc.setFontSize(11);
      headers.forEach((h, i) => doc.text(h, centers[i], 217, { align: "center" }));

      y = 225;
    }

    function addFooter() {
      const footerY = pageHeight - 50;
      doc.setFont("times", "normal");
      doc.setFontSize(12);
      doc.text("Department Exam Cell In-charge", 100, footerY);
      doc.text("HoD", pageWidth - 100, footerY, { align: "right" });
    }

    addHeader();

    const tableLeft = 50;
    const tableRight = pageWidth - 50;
    const colX = [tableLeft, 110, 200, 350, 500, tableRight];
    const centers = [80, 155, 275, 425, 525];

    for (const hall of Object.keys(groupedByHall)) {
      const hallStudents = groupedByHall[hall];
      const courseGroups = {};

      hallStudents.forEach(s => {
        const course = s["Subject Code"] || s["Course Code"] || "";
        const year = s["Year"] || "";
        const section = s["Section"] || "";
        const key = `${course}_${year}_${section}`;
        if (!courseGroups[key]) courseGroups[key] = [];
        courseGroups[key].push(s);
      });

      const hallStartY = y;
      let hallEndY = y;

      const courseKeys = Object.keys(courseGroups);
      courseKeys.forEach((key, idx) => {
        const [courseCode, year, section] = key.split("_");
        const list = courseGroups[key];
        const rollNos = list.map(s => s["Student Roll No"] || s["Register No"] || "").filter(Boolean).sort();
        const rollText =
          rollNos.length === 1
            ? rollNos[0]
            : rollNos.length > 1
            ? `${rollNos[0]} - ${rollNos[rollNos.length - 1]}`
            : "-";

        const rowHeight = 20;
        if (y + rowHeight > pageHeight - 80) {
          addFooter();
          doc.addPage();
          addHeader();
          y = 225;
        }

        doc.rect(110, y, tableRight - 110, rowHeight);
        for (const x of colX.slice(2, -1)) doc.line(x, y, x, y + rowHeight);

        doc.setFont("times", "normal");
        doc.setFontSize(11);
        doc.text(courseCode, centers[1], y + 14, { align: "center" });
        doc.text(`${year} ${user.department} ${section}`, centers[2], y + 14, { align: "center" });
        doc.text(rollText, centers[3], y + 14, { align: "center" });
        doc.text(String(rollNos.length), centers[4], y + 14, { align: "center" });

        y += rowHeight;
        hallEndY = y;
      });

      doc.rect(50, hallStartY, 60, hallEndY - hallStartY);
      doc.text(hall, 80, (hallStartY + hallEndY) / 2 - 3, { align: "center" });
      doc.line(50, hallEndY, pageWidth - 50, hallEndY);
    }

    addFooter();
    doc.save(`Hall_Plan_Schedule_${user.department}_${selectedDate}_${selectedBatch}.pdf`);
  } catch (err) {
    console.error("generateHallPlanSchedule error:", err);
    alert("Error generating hall plan schedule: " + (err.message || err));
  }
}

</script>
</body>
</html>
